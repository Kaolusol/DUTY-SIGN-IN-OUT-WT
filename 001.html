<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAVE TOWN | Employee Portal</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: #0a0a0a; color: #fff; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; gap: 5px; }
        .lang-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 12px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 0.8rem; transition: 0.3s; }
        .lang-btn.active { background: #00d2ff; color: #000; border-color: #00d2ff; }
        #clickLayer { position: fixed; inset: 0; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 20000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .start-btn { padding: 15px 40px; background: transparent; border: 2px solid #00d2ff; color: #00d2ff; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .start-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 20px #00d2ff; }
        .container { background: #111; padding: 40px 30px; border-radius: 25px; border: 1px solid #333; width: 100%; max-width: 400px; text-align: center; display: none; position: relative; }
        .logo-mid { height: 80px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 16px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; font-family: 'Kanit'; text-align: center; font-size: 1rem; outline: none; text-transform: uppercase; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn { padding: 16px 5px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Kanit'; font-size: 0.9rem; transition: 0.2s; }
        .btn-in { background: #00ff88; color: #000; }
        .btn-out { background: #ff4d4d; color: #fff; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .status-box { position: fixed; bottom: 20px; left: 20px; font-size: 11px; color: #ffb300; font-weight: bold; }
        .sv-status { font-size: 12px; margin-bottom: 10px; font-weight: bold; }
        .id-hint { font-size: 10px; color: #666; margin-top: -5px; margin-bottom: 10px; }
        #msg { margin-top: 20px; font-size: 13px; min-height: 1.5em; font-weight: bold; }
    </style>
</head>
<body>

<div class="lang-switch">
    <button type="button" class="lang-btn active" id="btn-th" onclick="setLanguage('th')">TH</button>
    <button type="button" class="lang-btn" id="btn-en" onclick="setLanguage('en')">EN</button>
</div>

<div id="clickLayer">
    <img src="WT.logo.png" style="height: 100px; margin-bottom: 30px;">
    <button class="start-btn" onclick="activateSystem()">START PORTAL</button>
</div>

<div class="container" id="mainPortal">
    <img src="WT.logo.png" class="logo-mid">
    <div id="sv-indicator" class="sv-status">SERVER: CHECKING...</div>
    <h2 id="t-title" style="margin: 5px 0; color: #00d2ff;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
    <input type="text" id="staffId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" autocomplete="off" maxlength="7">
    <div class="id-hint">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ABC, AB-123, ABC-12</div>
    <select id="dept">
        <option value="" disabled selected id="t-select-dept">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
        <option value="DOT">DOT (‡∏ä‡πà‡∏≤‡∏á)</option>
        <option value="POLICE">POLICE (‡∏ï‡∏≥‡∏£‡∏ß‡∏à)</option>
        <option value="FIRE/MEDIC">FIRE/MEDIC (‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á/‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û)</option>
        <option value="COURT">COURT (‡∏®‡∏≤‡∏•)</option>
    </select>
    <div class="btn-group">
        <button class="btn btn-in" id="t-btn-in" onclick="updateStatus('Duty On')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (DUTY ON)</button>
        <button class="btn btn-out" id="t-btn-out" onclick="updateStatus('Duty Off')">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (DUTY OFF)</button>
    </div>
    <div id="msg"></div>
</div>

<audio id="mainMusic" loop><source src="final.mp3" type="audio/mpeg"></audio>
<div class="status-box" id="t-status">AUDIO: WAITING...</div>

<script>
    // Config & Webhook
    const firebaseConfig = {
        apiKey: "AIzaSyDVCzhpm7-krLUntUMDCI9ZdcKJOolMw8c",
        authDomain: "admin-duty-sign-inout-wt.firebaseapp.com",
        databaseURL: "https://admin-duty-sign-inout-wt-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "admin-duty-sign-inout-wt",
        storageBucket: "admin-duty-sign-inout-wt.firebasestorage.app",
        messagingSenderId: "676786771738",
        appId: "1:676786771738:web:22312dc2df3daa73333ea3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const discordURL = "https://discord.com/api/webhooks/1457197809588764879/gshW16NL-8NOcGgjB3AOQwsHxMKTVyjXHAK9V5cti87pxT0f1rY5iz9aer4IQ4gePcOu";

    const audio = document.getElementById('mainMusic');
    let currentLang = 'th';
    let isServerOpen = false;

    const translations = {
        th: { title: "‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô", placeholder: "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", select: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", btnIn: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (DUTY ON)", btnOut: "‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (DUTY OFF)", success: "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", error: "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", invalidId: "‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", svClosed: "‚ùå ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà" },
        en: { title: "DUTY SIGN IN/OUT", placeholder: "STAFF ID", select: "SELECT DEPARTMENT", btnIn: "DUTY ON", btnOut: "DUTY OFF", success: "‚úÖ SAVED", error: "‚ùå MISSING INFO", invalidId: "‚ùå INVALID FORMAT", svClosed: "‚ùå SERVER CLOSED" }
    };

    // Server Monitoring
    db.ref('server/status').on('value', snap => {
        isServerOpen = (snap.val() === 'open');
        const ind = document.getElementById('sv-indicator');
        ind.innerText = isServerOpen ? "‚óè SERVER ONLINE" : "‚óã SERVER OFFLINE";
        ind.style.color = isServerOpen ? "#00ff88" : "#ff4d4d";
        document.getElementById('t-btn-in').disabled = !isServerOpen;
    });

    function validateId(id) {
        const p1 = /^[A-Z]{3}$/;            // XXX
        const p2 = /^[A-Z]{2}-[0-9]{3}$/;    // XX-000
        const p3 = /^[A-Z]{3}-[0-9]{2}$/;    // XXX-00
        return p1.test(id) || p2.test(id) || p3.test(id);
    }

    function sendDiscord(staffId, dept, status, time, totalMins) {
        let desc = `**‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:** ${dept}\n**‡πÄ‡∏ß‡∏•‡∏≤:** ${time}`;
        if (status === 'Duty Off') {
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            desc += `\n**‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô:** ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        fetch(discordURL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                embeds: [{
                    title: `üì¢ STAFF: ${staffId} [${status.toUpperCase()}]`,
                    description: desc,
                    color: status === 'Duty On' ? 3066993 : 15158332,
                    timestamp: new Date().toISOString()
                }]
            })
        });
    }

    function updateStatus(status) {
        const id = document.getElementById('staffId').value.trim().toUpperCase();
        const dept = document.getElementById('dept').value;
        const msg = document.getElementById('msg');
        if (status === 'Duty On' && !isServerOpen) return;
        if (!id || !dept) { msg.innerText = translations[currentLang].error; msg.style.color="#ff4d4d"; return; }
        if (!validateId(id)) { msg.innerText = translations[currentLang].invalidId; msg.style.color="#ffb300"; return; }

        const ts = Date.now();
        const tStr = new Date().toLocaleTimeString('th-TH');
        const ref = db.ref('attendance/' + id);

        ref.once('value').then(snap => {
            const data = snap.val() || {};
            let total = data.totalMinutes || 0;
            if (status === 'Duty Off' && data.status === 'Duty On') {
                total += Math.floor((ts - data.lastOnTimestamp) / 60000);
            }
            const up = { id, dept, status, time: tStr, totalMinutes: total };
            if (status === 'Duty On') up.lastOnTimestamp = ts;
            return ref.update(up).then(() => {
                sendDiscord(id, dept, status, tStr, total);
                msg.innerText = translations[currentLang].success; msg.style.color="#00ff88";
                document.getElementById('staffId').value = "";
                setTimeout(() => msg.innerText="", 3000);
            });
        });
    }

    function activateSystem() {
        audio.play().then(() => {
            document.getElementById('t-status').innerText = "AUDIO: PLAYING";
            document.getElementById('clickLayer').style.display = "none";
            document.getElementById('mainPortal').style.display = "block";
        });
    }

    function setLanguage(l) {
        currentLang = l;
        document.getElementById('btn-th').classList.toggle('active', l === 'th');
        document.getElementById('btn-en').classList.toggle('active', l === 'en');
        const t = translations[l];
        document.getElementById('t-title').innerText = t.title;
        document.getElementById('staffId').placeholder = t.placeholder;
        document.getElementById('t-select-dept').innerText = t.select;
        document.getElementById('t-btn-in').innerText = t.btnIn;
        document.getElementById('t-btn-out').innerText = t.btnOut;
    }

    window.addEventListener('keydown', e => {
        if (document.activeElement.tagName === 'INPUT') return;
        if (e.key.toLowerCase() === 'm' || e.key === '‡∏ó') {
            audio.muted = !audio.muted;
            document.getElementById('t-status').innerText = audio.muted ? "AUDIO: MUTED" : "AUDIO: PLAYING";
        }
    });
</script>
</body>
</html>
